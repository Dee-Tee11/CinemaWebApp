name: ğŸ§  Update RAG Index

on:
  # Trigger manual (para primeira indexaÃ§Ã£o)
  workflow_dispatch:
    inputs:
      mode:
        description: "Indexation mode"
        required: true
        default: "incremental"
        type: choice
        options:
          - full
          - incremental

  # Trigger automÃ¡tico quando cÃ³digo muda
  push:
    branches:
      - main
    paths:
      - "**.py"
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"

  # Trigger agendado (toda semana para garantir sincronizaÃ§Ã£o)
  schedule:
    - cron: "0 3 * * 1" # Segunda-feira Ã s 3h UTC

jobs:
  update-index:
    runs-on: ubuntu-latest

    permissions:
      contents: write # NecessÃ¡rio para commitar a BD atualizada

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ SETUP PYTHON
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ DOWNLOAD INDEXER DO ACTION REPO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Download RAG indexer
        run: |
          echo "Downloading indexer from ai-code-reviewer repo..."

          # Download dos ficheiros necessÃ¡rios
          curl -fsSL -o indexer.py \
            https://raw.githubusercontent.com/Dee-Tee11/ai-code-reviewer/main/indexer.py

          curl -fsSL -o codebase_rag.py \
            https://raw.githubusercontent.com/Dee-Tee11/ai-code-reviewer/main/codebase_rag.py

          echo "âœ… Indexer downloaded successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ INSTALL DEPENDENCIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Install RAG dependencies
        run: |
          pip install --quiet chromadb sentence-transformers torch
          echo "âœ… Dependencies installed"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” DETECT CHANGED FILES (para incremental)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Detect changed files
        id: detect-changes
        if: github.event_name == 'push'
        run: |
          # Detectar ficheiros modificados no Ãºltimo commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | \
            grep -E '\.(py|ts|tsx|js|jsx)$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Converter para formato de argumento (espaÃ§os)
            FILES_ARG=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_ARG" >> $GITHUB_OUTPUT
            
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ§  UPDATE INDEX (INCREMENTAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§  Update RAG Index (Incremental)
        if: |
          github.event_name == 'push' && 
          steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“ Incremental update for ${{ steps.detect-changes.outputs.file_count }} files"

          python indexer.py \
            --repo . \
            --mode incremental \
            --files ${{ steps.detect-changes.outputs.files }} \
            --db-path ./chroma_db

          echo "âœ… Incremental indexation complete"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ§  UPDATE INDEX (FULL - MANUAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§  Update RAG Index (Full - Manual)
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.mode == 'full'
        run: |
          echo "ğŸ”„ Full re-indexation (manual trigger)"

          python indexer.py \
            --repo . \
            --mode full \
            --db-path ./chroma_db \
            --reset

          echo "âœ… Full indexation complete"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ§  UPDATE INDEX (FULL - SCHEDULED)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§  Update RAG Index (Full - Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "ğŸ”„ Weekly full re-indexation"

          python indexer.py \
            --repo . \
            --mode full \
            --db-path ./chroma_db

          echo "âœ… Scheduled indexation complete"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š SHOW STATISTICS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Show index statistics
        if: |
          (github.event_name == 'push' && steps.detect-changes.outputs.has_changes == 'true') ||
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'schedule'
        run: |
          echo "### ğŸ“Š RAG Index Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python -c "
          from codebase_rag import CodebaseRAG
          import os

          try:
              rag = CodebaseRAG(persist_directory='./chroma_db')
              stats = rag.get_stats()
              
              # Usar .get() com valor padrÃ£o para evitar KeyError
              total_files = stats.get('total_files', 0)
              total_functions = stats.get('total_functions', 0)
              total_deps = stats.get('total_dependencies', None)
              
              print(f'**Total files indexed:** {total_files}')
              print(f'**Total functions/components:** {total_functions}')
              
              # SÃ³ mostrar dependencies se disponÃ­vel
              if total_deps is not None:
                  print(f'**Total dependencies tracked:** {total_deps}')
              
              # Calcular tamanho da base de dados
              if os.path.exists('./chroma_db'):
                  total_size = sum(
                      os.path.getsize(os.path.join(dirpath, filename))
                      for dirpath, _, filenames in os.walk('./chroma_db')
                      for filename in filenames
                  )
                  size_mb = total_size / (1024 * 1024)
                  print(f'**Database size:** {size_mb:.2f} MB')
              else:
                  print('**Database size:** N/A')
              
          except Exception as e:
              print(f'âš ï¸ Error collecting statistics: {str(e)}')
              print('Index may still be valid, but stats unavailable.')
          " >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **RAG is now ready for context-aware code reviews!**" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ COMMIT UPDATED INDEX
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¾ Commit updated RAG index
        if: |
          (github.event_name == 'push' && steps.detect-changes.outputs.has_changes == 'true') ||
          github.event_name == 'workflow_dispatch' ||
          github.event_name == 'schedule'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Adicionar apenas a base de dados
          git add chroma_db/

          # Verificar se hÃ¡ mudanÃ§as
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Criar mensagem de commit informativa
            if [ "${{ github.event_name }}" == "push" ]; then
              COMMIT_MSG="ğŸ¤– Update RAG index (incremental - ${{ steps.detect-changes.outputs.file_count }} files) [skip ci]"
            elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              COMMIT_MSG="ğŸ¤– Update RAG index (full - manual) [skip ci]"
            else
              COMMIT_MSG="ğŸ¤– Update RAG index (full - scheduled) [skip ci]"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            
            echo "âœ… RAG index committed and pushed"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ§¹ CLEANUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          # Remover ficheiros temporÃ¡rios do indexer
          rm -f indexer.py codebase_rag.py
          echo "âœ… Cleanup complete"
