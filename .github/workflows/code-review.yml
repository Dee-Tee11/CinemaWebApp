  name: ðŸŽ“ AI Code Review (with RAG + Groq)

  on:
    push:
      branches: ["**"]
    pull_request:
      types: [opened, synchronize, reopened]

  jobs:
    review:
      runs-on: ubuntu-latest

      permissions:
        contents: write
        pull-requests: write
        issues: write

      steps:
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ðŸ“¥ CHECKOUT
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        - name: ðŸ“¥ Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GH_TOKEN }}

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ðŸ§  VERIFICAR SE RAG DATABASE EXISTE
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        - name: ðŸ§  Check RAG Database
          id: check-rag
          run: |
            if [ -d "./chroma_db" ] && [ -n "$(ls -A ./chroma_db 2>/dev/null)" ]; then
              echo "rag_available=true" >> $GITHUB_OUTPUT
              echo "âœ… RAG database found - reviews will have full context!"
              
              if [ -f "chroma_db/chroma.sqlite3" ]; then
                DB_SIZE=$(du -sh chroma_db | cut -f1)
                echo "ðŸ“Š Database size: $DB_SIZE"
              fi
            else
              echo "rag_available=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ RAG database not found - review will proceed without context"
            fi

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ðŸ’¾ CACHE DA RAG DATABASE
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        - name: ðŸ’¾ Restore RAG Database Cache
          if: steps.check-rag.outputs.rag_available == 'true'
          uses: actions/cache@v3
          with:
            path: ./chroma_db
            key: rag-db-${{ github.repository }}-${{ hashFiles('**/*.py', '**/*.js', '**/*.ts', '**/*.tsx', '**/*.jsx') }}
            restore-keys: |
              rag-db-${{ github.repository }}-

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ðŸ¤– AI CODE REVIEW (GROQ)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        - name: ðŸŽ“ AI Code Mentor (Groq)
          uses: Dee-Tee11/ai-code-reviewer@main
          with:
            groq: ${{ secrets.GROQ }}
            github_token: ${{ secrets.GH_TOKEN }}
            enable_rag: ${{ steps.check-rag.outputs.rag_available }}
            rag_db_path: ./chroma_dbs

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ðŸ“Š ESTATÃSTICAS
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        - name: ðŸ“Š Review Statistics
          if: always()
          run: |
            echo "### ðŸ“Š Review Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **AI Provider:** âš¡ Groq (ultra-fast)" >> $GITHUB_STEP_SUMMARY
            echo "- **RAG Context:** ${{ steps.check-rag.outputs.rag_available == 'true' && 'âœ… Enabled' || 'âš ï¸ Disabled' }}" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check-rag.outputs.rag_available }}" == "true" ]; then
              if [ -d "./chroma_db" ]; then
                DB_SIZE=$(du -sh chroma_db 2>/dev/null | cut -f1 || echo "unknown")
                echo "- **Database Size:** $DB_SIZE" >> $GITHUB_STEP_SUMMARY
              fi
            fi
