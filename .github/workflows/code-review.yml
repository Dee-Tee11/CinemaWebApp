name: ðŸŽ“ AI Code Review (with RAG)

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: write # NecessÃ¡rio para commitar (se for o caso)
      pull-requests: write # NecessÃ¡rio para comentar em PRs
      issues: write # NecessÃ¡rio para comentÃ¡rios

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # â† Mudado de 2 para 0 (necessÃ¡rio para RAG)
          token: ${{ secrets.GH_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ§  VERIFICAR SE RAG ESTÃ DISPONÃVEL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ§  Check RAG database
        id: check-rag
        run: |
          if [ -d "./chroma_db" ]; then
            echo "rag_available=true" >> $GITHUB_OUTPUT
            echo "âœ… RAG database found - reviews will have full context!"
            
            # Mostrar stats da BD
            if [ -f "chroma_db/dependencies.json" ]; then
              FILE_COUNT=$(cat chroma_db/dependencies.json | grep -o '"' | wc -l)
              echo "ðŸ“Š Database contains indexed codebase"
            fi
          else
            echo "rag_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ RAG database not found - running without context"
            echo "ðŸ’¡ Run 'Update RAG Index' workflow to enable context-aware reviews"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ¤– AI CODE REVIEW (COM RAG!)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸŽ“ AI Code Mentor (with RAG Context)
        uses: Dee-Tee11/ai-code-reviewer@main
        with:
          huggingface_token: ${{ secrets.HUGGINGFACE_TOKEN }}
          github_token: ${{ secrets.GH_TOKEN }}
          # â†“ NOVO: ConfiguraÃ§Ãµes RAG
          enable_rag: ${{ steps.check-rag.outputs.rag_available }}
          rag_db_path: ./chroma_db

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š ESTATÃSTICAS (OPCIONAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“Š Review Statistics
        if: always()
        run: |
          echo "### ðŸ“Š Review Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Enabled:** ${{ steps.check-rag.outputs.rag_available }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-rag.outputs.rag_available }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Reviews include context from your entire codebase!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Reviews without RAG context**" >> $GITHUB_STEP_SUMMARY
            echo "Run the 'Update RAG Index' workflow to enable smart reviews." >> $GITHUB_STEP_SUMMARY
          fi
