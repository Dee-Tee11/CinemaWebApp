name: ðŸŽ“ AI Code Review (with RAG)

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: write # NecessÃ¡rio para commitar (se for o caso)
      pull-requests: write # NecessÃ¡rio para comentar em PRs
      issues: write # NecessÃ¡rio para comentÃ¡rios

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para RAG indexar todo o histÃ³rico
          token: ${{ secrets.GH_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ§  VERIFICAR SE RAG ESTÃ DISPONÃVEL OU CONSTRUIR
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ§  Check or Build RAG database
        id: check-rag
        run: |
          if [ -d "./chroma_db" ] && [ -n "$(ls -A ./chroma_db 2>/dev/null)" ]; then
            echo "rag_available=true" >> $GITHUB_OUTPUT
            echo "âœ… RAG database found - reviews will have full context!"
            
            # Mostrar stats da BD se existir
            if [ -f "chroma_db/chroma.sqlite3" ]; then
              DB_SIZE=$(du -sh chroma_db | cut -f1)
              echo "ðŸ“Š Database size: $DB_SIZE"
            fi
          else
            echo "rag_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ RAG database not found"
            echo "ðŸ”¨ Will build RAG database during review..."
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ¤– AI CODE REVIEW (COM RAG!)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸŽ“ AI Code Mentor (with RAG Context)
        uses: Dee-Tee11/ai-code-reviewer@main
        with:
          huggingface_token: ${{ secrets.HUGGINGFACE_TOKEN }}
          github_token: ${{ secrets.GH_TOKEN }}
          enable_rag: "true" # â† Sempre ativa RAG (a action constrÃ³i se nÃ£o existir)
          rag_db_path: ./chroma_db

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ’¾ CACHE DA RAG DATABASE (OPCIONAL MAS RECOMENDADO)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ’¾ Cache RAG database
        uses: actions/cache@v3
        with:
          path: ./chroma_db
          key: rag-db-${{ github.repository }}-${{ hashFiles('**/*.py', '**/*.js', '**/*.ts') }}
          restore-keys: |
            rag-db-${{ github.repository }}-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š ESTATÃSTICAS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“Š Review Statistics
        if: always()
        run: |
          echo "### ðŸ“Š Review Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Enabled:** true" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

          if [ -d "./chroma_db" ]; then
            DB_SIZE=$(du -sh chroma_db 2>/dev/null | cut -f1 || echo "unknown")
            echo "- **RAG Database:** $DB_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Reviews include context from your entire codebase!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **RAG database building failed**" >> $GITHUB_STEP_SUMMARY
          fi
