name: ðŸŽ“ AI Code Review (with RAG)

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: write # NecessÃ¡rio para commitar (se for o caso)
      pull-requests: write # NecessÃ¡rio para comentar em PRs
      issues: write # NecessÃ¡rio para comentÃ¡rios

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para histÃ³rico completo
          token: ${{ secrets.GH_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ” DEBUG GITHUB CONTEXT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Debug GitHub Context
        run: |
          echo "### ðŸ” GitHub Context" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸž Debug Workspace Contents
        run: |
          echo "Listing all files in the workspace..."
          ls -laR
          echo "---"
          echo "Checking root .gitignore contents..."
          cat .gitignore || echo "Root .gitignore not found"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ§  VERIFICAR SE RAG DATABASE EXISTE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ§  Check RAG Database
        id: check-rag
        run: |
          if [ -d "./chroma_db" ] && [ -n "$(ls -A ./chroma_db 2>/dev/null)" ]; then
            echo "rag_available=true" >> $GITHUB_OUTPUT
            echo "âœ… RAG database found - reviews will have full context!"
            
            # Mostrar stats da BD
            if [ -f "chroma_db/chroma.sqlite3" ]; then
              DB_SIZE=$(du -sh chroma_db | cut -f1)
              echo "ðŸ“Š Database size: $DB_SIZE"
            fi
          else
            echo "rag_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ RAG database not found"
            echo "ðŸ’¡ To enable RAG context:"
            echo "   1. Run locally: python .rag/build.py"
            echo "   2. Commit: git add chroma_db/ && git commit -m 'ðŸ§  Add RAG database'"
            echo "   3. Push: git push"
            echo ""
            echo "âš¡ Review will proceed without RAG context"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ’¾ CACHE DA RAG DATABASE (RESTAURAR SE EXISTIR)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ’¾ Restore RAG Database Cache
        if: steps.check-rag.outputs.rag_available == 'true'
        uses: actions/cache@v3
        with:
          path: ./chroma_db
          key: rag-db-${{ github.repository }}-${{ hashFiles('**/*.py', '**/*.js', '**/*.ts', '**/*.tsx', '**/*.jsx') }}
          restore-keys: |
            rag-db-${{ github.repository }}-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ¤– AI CODE REVIEW (COM OU SEM RAG)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸŽ“ AI Code Mentor
        uses: Dee-Tee11/ai-code-reviewer@main
        with:
          huggingface_token: ${{ secrets.HUGGINGFACE_TOKEN }}
          github_token: ${{ secrets.GH_TOKEN }}
          enable_rag: ${{ steps.check-rag.outputs.rag_available }}
          rag_db_path: ./chroma_db

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ” TESTAR API DO GITHUB
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Debug GitHub API Access
        if: always()
        run: |
          echo "### ðŸ” Testing GitHub API Access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test authentication
          echo "Testing authentication..."
          AUTH_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user)
          echo "âœ… Authenticated as: $(echo $AUTH_RESPONSE | jq -r '.login')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test comment posting
          echo "Attempting to post test comment..."
          COMMENT_RESPONSE=$(curl -s -X POST \
               -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
               -d '{"body":"ðŸ§ª Test comment from workflow - if you see this, API access works!","path":"webapp/src/components/SettingsPopup.tsx","position":1}')

          if echo "$COMMENT_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
            echo "âœ… **Test comment posted successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "Comment ID: $(echo $COMMENT_RESPONSE | jq -r '.id')" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed to post test comment**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$COMMENT_RESPONSE" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š ESTATÃSTICAS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“Š Review Statistics
        if: always()
        run: |
          echo "### ðŸ“Š Review Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Enabled:** ${{ steps.check-rag.outputs.rag_available }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-rag.outputs.rag_available }}" == "true" ]; then
            if [ -d "./chroma_db" ]; then
              DB_SIZE=$(du -sh chroma_db 2>/dev/null | cut -f1 || echo "unknown")
              echo "- **RAG Database:** $DB_SIZE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Reviews include context from your entire codebase!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Review completed without RAG context**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable RAG and get better reviews:" >> $GITHUB_STEP_SUMMARY
            echo "1. Run: \`python .rag/build.py\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Commit: \`git add chroma_db/ && git commit -m 'ðŸ§  Add RAG database'\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Push: \`git push\`" >> $GITHUB_STEP_SUMMARY
          fi
